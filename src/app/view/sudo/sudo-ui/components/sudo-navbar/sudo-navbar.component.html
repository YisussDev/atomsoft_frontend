<!-- Mobile Overlay (fuera del aside) -->
<div
  *ngIf="isMobileOpen && isMobile"
  (click)="closeMobile()"
  [@fadeIn]
  class="fixed inset-0 bg-black/50 z-40 lg:hidden"
  style="pointer-events: auto;"
></div>

<aside
  [class]="getAsideClasses()"
  [style.width.px]="!isMobile ? (isCollapsed ? collapsedWidth : expandedWidth) : null"
  [style.height]="!isMobile ? '100%' : null"
>
  <!-- Header -->
  <div class="flex items-center justify-between border-b border-btw h-12 px-2 bg-white">
    <div
      [class]="'flex items-center gap-3 transition-opacity duration-200 ' + (isCollapsed && !isMobileOpen ? 'opacity-0 w-0 overflow-hidden' : 'opacity-100')">
      <div class="w-8 h-8 rounded-lg flex items-center justify-center text-white font-bold bg-btw-primary p-2">
        <img src="assets/img/logos/logo_praxi.svg" alt="logo_company" class="object-cover">
      </div>
      <span appTypography="subtitle">{{ appName }}</span>
    </div>
    <button
      (click)="toggleCollapse()"
      class="p-2 hover:bg-gray-100 rounded-lg transition-colors flex-shrink-0"
      [title]="isMobile ? (isMobileOpen ? 'Cerrar' : 'Abrir menú') : (isCollapsed ? 'Expandir' : 'Contraer')"
    >
      <!-- Icono X para cerrar cuando está abierto en móvil -->
      <svg *ngIf="isMobile && isMobileOpen" class="w-5 h-5 text-btw" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
      </svg>
      <!-- Icono chevron para desktop -->
      <svg *ngIf="!isMobile" class="w-5 h-5 text-btw" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path *ngIf="!isCollapsed" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path>
        <path *ngIf="isCollapsed" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M13 5l7 7-7 7M5 5l7 7-7 7"></path>
      </svg>
    </button>
  </div>

  <!-- Navigation Items -->
  <nav class="flex-1 overflow-y-auto py-4 px-2">
    <ng-container *ngFor="let item of navItems; let i = index">
      <ng-container *ngIf="item.divider">
        <hr class="my-2 border-btw">
      </ng-container>
      <ng-container *ngIf="!item.divider">
        <div>
          <!-- Parent Item -->
          <div
            (click)="handleItemClick(item, i, $event)"
            (mouseenter)="showFloatingSubmenu(i, $event)"
            (mouseleave)="!isMobile && isCollapsed ? null : hideFloatingSubmenu()"
            [class]="getItemClasses(item, i)"
            [attr.title]="isCollapsed && !isMobileOpen ? item.label : ''"
          >
            <div class="flex items-center gap-3 flex-1 min-w-0">
              <ng-container *ngIf="item.icon">
                <app-icon-material
                  [nameIcon]="item.icon"
                  sizeIcon="large"
                  [class]="'p-0 m-0 ' + (hasActiveChild(item, i) ? 'text-blue-600' : 'text-btw')"
                ></app-icon-material>
              </ng-container>
              <span
                appTypography="semi_medium"
                [class]="'truncate transition-all duration-200 ' + (isCollapsed && !isMobileOpen ? 'opacity-0 w-0' : 'opacity-100')">
                {{ item.label | titlecase }}
              </span>
              <span
                *ngIf="item.badge && (!isCollapsed || isMobileOpen)"
                class="ml-auto px-2 py-0.5 text-xs rounded-full bg-red-500 text-white flex-shrink-0"
              >
                {{ item.badge }}
              </span>
            </div>
            <!-- Chevron for items with children (solo cuando está expandido o en móvil abierto) -->
            <svg
              *ngIf="item.children && item.children.length > 0 && (!isCollapsed || isMobileOpen)"
              [@rotate]="expandedItems[i] ? 'expanded' : 'collapsed'"
              class="w-4 h-4 text-gray-400 flex-shrink-0 ml-2"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
            <!-- Indicador de que tiene hijos cuando está colapsado -->
            <div
              *ngIf="item.children && item.children.length > 0 && isCollapsed && !isMobileOpen"
              class="w-1 h-1 rounded-full bg-blue-500 flex-shrink-0 ml-auto"
            ></div>
          </div>

          <!-- Children Items (expandidos normalmente) -->
          <div
            *ngIf="item.children && item.children.length > 0 && (!isCollapsed || isMobileOpen) && expandedItems[i]"
            [@slideDown]
            class="ml-4 mt-1 space-y-1"
          >
            <div
              *ngFor="let child of item.children; let j = index"
              (click)="handleChildClick(child, i, j)"
              [class]="getChildClasses(child, i, j)"
            >
              <div class="flex items-center gap-3 flex-1 min-w-0">
                <ng-container *ngIf="child.icon">
                  <app-icon-material [nameIcon]="child.icon" sizeIcon="large"
                                     class="p-0 m-0 text-btw"></app-icon-material>
                </ng-container>
                <span appTypography="semi_medium" class="truncate">{{ child.label }}</span>
                <span
                  *ngIf="child.badge"
                  class="ml-auto px-2 py-0.5 text-xs rounded-full bg-red-500 text-white flex-shrink-0"
                >
                  {{ child.badge }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </ng-container>
    </ng-container>
  </nav>

  <!-- Footer -->
  <div class="border-t border-gray-200 p-4">
    <div [class]="'flex items-center gap-3 transition-all duration-200 ' + (isCollapsed && !isMobileOpen ? 'justify-center' : '')">
      <div
        class="w-10 h-10 bg-chill bg-primary rounded-full flex items-center justify-center text-white font-bold flex-shrink-0">
        {{ userInitial }}
      </div>
      <div
        [class]="'flex-1 min-w-0 transition-opacity duration-200 ' + (isCollapsed && !isMobileOpen ? 'opacity-0 w-0 overflow-hidden' : 'opacity-100')">
        <p appTypography="semi_medium" class="truncate">{{ userName }}</p>
        <p appTypography="paragraph" class="truncate">{{ userRole }}</p>
      </div>
    </div>
  </div>
</aside>

<!-- Floating Submenu (cuando está colapsado en desktop) -->
<div
  *ngIf="hoveredParentIndex !== null && isCollapsed && !isMobile && navItems[hoveredParentIndex].children"
  [@fadeIn]
  (mouseenter)="hoveredParentIndex = hoveredParentIndex"
  (mouseleave)="hideFloatingSubmenu()"
  [style.top.px]="submenuPosition.top"
  [style.left.px]="submenuPosition.left + 10"
  class="fixed bg-white border border-gray-200 rounded-lg shadow-xl py-2 px-2 min-w-[200px] z-[60]"
>
  <div class="space-y-1">
    <div
      *ngFor="let child of navItems[hoveredParentIndex].children; let j = index"
      (click)="handleChildClick(child, hoveredParentIndex!, j)"
      [class]="getChildClasses(child, hoveredParentIndex!, j)"
    >
      <div class="flex items-center gap-3 flex-1 min-w-0">
        <ng-container *ngIf="child.icon">
          <app-icon-material [nameIcon]="child.icon" sizeIcon="large"
                             class="p-0 m-0 text-btw"></app-icon-material>
        </ng-container>
        <span appTypography="semi_medium" class="truncate">{{ child.label }}</span>
        <span
          *ngIf="child.badge"
          class="ml-auto px-2 py-0.5 text-xs rounded-full bg-red-500 text-white flex-shrink-0"
        >
          {{ child.badge }}
        </span>
      </div>
    </div>
  </div>
</div>
