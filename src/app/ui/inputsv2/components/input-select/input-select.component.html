<div class="w-full">
  <!-- Label -->
  <label *ngIf="label" [for]="id" class="block text-sm font-medium text-gray-700 mb-2">
    {{ label }}
    <span *ngIf="control?.hasError('required')" class="text-red-500">*</span>
  </label>

  <!-- Select Container -->
  <div class="relative">
    <!-- Icon -->
    <div *ngIf="icon" class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none z-10">
      <span class="transition-colors duration-200 flex justify-center items-center"
            [ngClass]="showError ? 'text-red-500' : 'text-gray-400'">
        <app-icon-material sizeIcon="large" class="m-0 p-0" [nameIcon]="icon"></app-icon-material>
      </span>
    </div>

    <!-- Select Button -->
    <button
      type="button"
      [id]="id"
      [disabled]="disabled"
      [class]="inputClasses"
      (click)="toggleDropdown()"
      (blur)="onBlur()"
      class="text-left cursor-pointer"
    >
      <span [ngClass]="selectedValue ? 'text-gray-900' : 'text-gray-500'">
        {{ getSelectedLabel() }}
      </span>
    </button>

    <!-- Dropdown Arrow -->
    <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none"
         [ngClass]="{'pr-10': clearable && selectedValue}">
      <svg
        class="h-5 w-5 transition-transform duration-200"
        [ngClass]="isOpen ? 'transform rotate-180 text-blue-500' : 'text-gray-400'"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
      </svg>
    </div>

    <!-- Clear Button -->
    <button
      *ngIf="clearable && selectedValue && !disabled"
      type="button"
      class="absolute inset-y-0 right-8 flex items-center pr-2 hover:text-red-500 transition-colors"
      (click)="clearSelection($event)"
    >
      <svg class="h-5 w-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd"
              d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
              clip-rule="evenodd"/>
      </svg>
    </button>

    <!-- Error Icon -->
    <div *ngIf="showError"
         class="absolute inset-y-0 flex items-center pointer-events-none"
         [ngClass]="clearable && selectedValue ? 'right-16' : 'right-10'">
      <svg class="h-5 w-5 text-red-500" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd"
              d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"
              clip-rule="evenodd"/>
      </svg>
    </div>

    <!-- Success Icon -->
    <div *ngIf="control?.valid && control?.dirty && !disabled && !showError"
         class="absolute inset-y-0 flex items-center pointer-events-none"
         [ngClass]="clearable && selectedValue ? 'right-16' : 'right-10'">
      <svg class="h-5 w-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd"
              d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
              clip-rule="evenodd"/>
      </svg>
    </div>

    <!-- Dropdown Menu -->
    <div *ngIf="isOpen"
         class="absolute z-20 mt-1 w-full bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-hidden">

      <!-- Search Input -->
      <div *ngIf="searchable" class="p-2 border-b border-gray-200">
        <input
          type="text"
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="Buscar..."
          [value]="searchTerm"
          (input)="onSearch($event)"
          (click)="$event.stopPropagation()"
        />
      </div>

      <!-- Options List -->
      <div class="overflow-y-auto max-h-48">
        <div *ngIf="filteredOptions.length === 0" class="px-4 py-3 text-gray-500 text-center">
          No hay opciones disponibles
        </div>

        <button
          *ngFor="let option of filteredOptions"
          type="button"
          class="w-full text-left px-4 py-3 hover:bg-blue-50 transition-colors duration-150 flex items-center justify-between"
          [ngClass]="{
            'bg-blue-100': isSelected(option),
            'text-gray-400 cursor-not-allowed': option.disabled,
            'cursor-pointer': !option.disabled
          }"
          [disabled]="option.disabled"
          (click)="selectOption(option)"
        >
          <div class="flex items-center space-x-3">
            <app-icon-material
              *ngIf="option.icon"
              sizeIcon="medium"
              [nameIcon]="option.icon"
            ></app-icon-material>
            <span>{{ option.label }}</span>
          </div>

          <!-- Checkmark for selected -->
          <svg
            *ngIf="isSelected(option)"
            class="h-5 w-5 text-blue-600"
            fill="currentColor"
            viewBox="0 0 20 20"
          >
            <path fill-rule="evenodd"
                  d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                  clip-rule="evenodd"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Error Message -->
  <div *ngIf="showError" class="mt-2 flex items-start">
    <p class="text-sm text-red-600 animate-shake">
      {{ errorMessage }}
    </p>
  </div>

  <!-- Hint -->
  <p *ngIf="hint && !showError" class="mt-2 text-sm text-gray-500">
    {{ hint }}
  </p>
</div>
