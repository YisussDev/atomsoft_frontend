<div class="w-full">
  <div class="rounded-md shadow-md border-btw border animation-opacity bg-btw-secondary">
    <ng-template [ngTemplateOutlet]="headerInfoTable"></ng-template>
    <ng-template [ngTemplateOutlet]="headerSearchTable"></ng-template>
    <table class="min-w-full">
      <ng-template [ngTemplateOutlet]="headerTable"></ng-template>
      <ng-container *ngIf="tableData.length > 0">
        <ng-template [ngTemplateOutlet]="bodyTable"></ng-template>
      </ng-container>
    </table>
    <ng-container *ngIf="tableData.length == 0">
      <app-empty-table></app-empty-table>
    </ng-container>
  </div>
</div>

<ng-template #headerInfoTable>
  <div class="grid grid-cols-2 h-14">
    <div class="flex flex-wrap justify-start gap-2 px-2 col-span-1">
      <div class="grid gap-2" style="grid-template-columns: 50px 1fr">
        <div class="h-full w-full flex justify-center items-center">
          <div
            class="h-10 w-10 bg-btw-primary flex justify-center items-center border border-btw text-btw text-xs rounded-md">
            <app-icon-material [nameIcon]="tablePrincipalIcon" sizeIcon="large"></app-icon-material>
          </div>
        </div>
        <div class="flex w-full justify-center items-start flex-col">
          <p class="text-btw font-medium text-sm">{{ tablePrincipalTitle }}</p>
          <p class="text-btw font-light text-xs">{{ tablePrincipalDescription }}</p>
        </div>
      </div>
    </div>
    <div class="flex flex-wrap items-center overflow-x-auto justify-end gap-2 px-2 col-span-1">
      <ng-container *ngIf="headerActions">
        <ng-container *ngFor="let action of tableHeaderActionsConfig">
          <button
            class="rounded-md flex gap-2
              h-10 p-2 justify-center
              border-btw border items-center
              min-w-fit text-xs
              select-none
              cursor-pointer"
            [ngStyle]="{
            'background-color': action.background || 'var(--color-bg)',
            'color': action.color || 'var(--color-text-btw)'
            }"
            (click)="eventRow('', action.nameEvent)">
            <app-icon-material [nameIcon]="action.icon" sizeIcon="medium"></app-icon-material>
            {{ action.label }}
          </button>
        </ng-container>
      </ng-container>
      <app-switch-simple [options]="switchOptionsTable" [activeValue]="switchOptionActive"
                         (changed)="changeTypeView($event)"></app-switch-simple>
    </div>
  </div>
  <hr class="text-btw">
</ng-template>

<ng-template #headerSearchTable>
  <ng-container [formGroup]="tableFormQueries">
    <div class="grid grid-cols-2 max-w-full overflow-hidden h-14 relative">
      <div
        class="flex gap-2 items-center text-btw bg-btw-secondary select-none border-r-btw w-full col-span-1 px-4">
        <span class="material-symbols-outlined">search</span>
        <input type="text" placeholder="Buscar..." formControlName="search"
               class="h-full hover:outline-0 hover:active:outline-0 focus:outline-0 bg-transparent w-max">
      </div>
      <div class="flex flex-wrap justify-end gap-2 w-full col-span-1 overflow-x-auto items-center px-4">
        <ng-container *ngIf="filterAction">
          <button
            class="rounded-md flex gap-2
            border-btw border py-2 px-3 items-center
            text-btw bg-btw-secondary select-none cursor-pointer"
            (click)="openModalExportData()">
            <span class="material-symbols-outlined">filter_alt</span>
            <p class="text-xs">Filtros</p>
          </button>
        </ng-container>
        <ng-container *ngIf="exportAction">
          <button
            class="rounded-md flex gap-2
            border-btw border p-3 items-center
            text-btw bg-btw-secondary select-none cursor-pointer"
            (click)="openModalExportData()">
            <span class="material-symbols-outlined">file_export</span>
            <p class="text-xs">Exportar Datos</p>
          </button>
        </ng-container>
        <button
          *ngIf="true"
          class="rounded-md flex gap-2
          h-10 p-2 justify-center
          border-btw border items-center
          min-w-fit
          text-btw bg-btw-secondary select-none cursor-pointer"
          (click)="openModalEditColumns()">
          <span class="material-symbols-outlined">tune</span>
        </button>
      </div>
    </div>
    <hr class="text-btw">
  </ng-container>
</ng-template>

<ng-template #headerTable>
  <thead class="border-b-btw text-btw">
  <tr class="h-10 border-b-btw">
    <ng-container *ngFor="let config of tableColumnConfig; let i = index;  trackBy: trackByFnHeader">
      <th class="text-ellipsis text-sm py-2 border-r-btw cursor-pointer" *ngIf="configColumn(config)"
          (click)="changeOrderColum(config)">
        <div class="w-full grid px-2" style="grid-template-columns: 1fr 30px">
          <ng-template #i>
            <p>{{ config.column_translate }}</p>
          </ng-template>
          <p class="text-left text-over-1-line select-none" [ngxTippy]="i">
            {{ config.column_translate }}
          </p>
          <div class="w-full h-full flex justify-center items-center border-l-btw select-none">
            <ng-container *ngIf="!config.column_order || (config.column_order == 'none')">
              <app-icon-material nameIcon="swap_vert"></app-icon-material>
            </ng-container>
            <ng-container *ngIf="config.column_order == 'asc'">
              <app-icon-material nameIcon="arrow_upward"></app-icon-material>
            </ng-container>
            <ng-container *ngIf="config.column_order == 'desc'">
              <app-icon-material nameIcon="arrow_downward"></app-icon-material>
            </ng-container>
          </div>
        </div>
      </th>
    </ng-container>
    <ng-container *ngIf="quicklyActions">
      <th class="text-ellipsis text-sm overflow-hidden border-r-btw">A/Rápidas</th>
    </ng-container>
    <ng-container *ngIf="multipleActions">
      <th class="text-ellipsis text-sm overflow-hidden border-r-btw">Acciones</th>
    </ng-container>
  </tr>
  <ng-container *ngIf="searchActions">
    <tr [formGroup]="tableFormQueries" class="text-btw h-10">
      <ng-container *ngFor="let config of tableColumnConfig;  trackBy: trackByFnHeader">
        <ng-container [ngSwitch]="config.column_type">
          <th *ngIf="configColumn(config)" class="border-r-btw h-10">
            <div class="grid w-full px-2 gap-1 h-10" style="grid-template-columns: 20px 1fr">
              <div class="flex w-full h-full justify-center items-center text-xs">
                <span class="material-symbols-outlined">search</span>
              </div>
              <div class="h-10">
                <ng-container *ngSwitchCase="'text'">
                  <ng-container *ngIf="!config.column_name.includes('.') && config.column_search">
                    <input type="text" [placeholder]="config.column_translate" [formControlName]="config.column_name"
                           class="w-full h-full bg-transparent px-4">
                  </ng-container>
                  <ng-container *ngIf="config.column_name.includes('.') && config.column_search">
                    <input type="text" [placeholder]="config.column_translate" disabled
                           class="w-full h-full bg-transparent px-4">
                  </ng-container>
                </ng-container>
                <ng-container *ngSwitchCase="'number'">
                  <ng-container *ngIf="!config.column_name.includes('.') && config.column_search">
                    <input type="number" [placeholder]="config.column_translate" [formControlName]="config.column_name"
                           class="w-full h-full bg-transparent px-4">
                  </ng-container>
                  <ng-container *ngIf="config.column_name.includes('.') && config.column_search">
                    <input type="number" [placeholder]="config.column_translate" disabled
                           class="w-full h-full bg-transparent px-4">
                  </ng-container>
                </ng-container>
                <ng-container *ngSwitchCase="'select'">
                  <ng-container *ngIf="!config.column_name.includes('.') && config.column_search">
                    <select [formControlName]="config.column_name"
                            class="w-full h-full bg-transparent px-4">
                      <option [value]="null">Seleccione Una Opción</option>
                      <ng-container *ngFor="let optionSelect of config.column_config">
                        <option [value]="optionSelect.custom_key">{{ optionSelect.custom_label }}</option>
                      </ng-container>
                    </select>
                  </ng-container>
                  <ng-container *ngIf="config.column_name.includes('.') && config.column_search">
                    <select [formControlName]="convertColumName(config.column_name)"
                            [disabled]="true"
                            class="w-full h-full bg-transparent px-4">
                      <option [value]="null">Seleccione Una Opción</option>
                      <ng-container *ngFor="let optionSelect of config.column_config">
                        <option [value]="optionSelect.custom_key">{{ optionSelect.custom_label }}</option>
                      </ng-container>
                    </select>
                  </ng-container>
                </ng-container>
                <ng-container *ngSwitchCase="'date'">
                  <ng-container *ngIf="!config.column_name.includes('.') && config.column_search"
                                class="w-full h-full bg-transparent px-4">
                    <input type="date" [placeholder]="config.column_translate" [formControlName]="config.column_name">
                  </ng-container>
                  <ng-container *ngIf="config.column_name.includes('.')">
                    <input type="date" [placeholder]="config.column_translate" disabled
                           class="w-full h-full bg-transparent px-4">
                  </ng-container>
                </ng-container>
              </div>
            </div>
          </th>
        </ng-container>
      </ng-container>
      <ng-container *ngIf="quicklyActions">
        <th class="border-r-btw"></th>
      </ng-container>
      <ng-container *ngIf="multipleActions">
        <th></th>
      </ng-container>
    </tr>
  </ng-container>
  </thead>
</ng-template>

<ng-template #bodyTable>
  <tbody>
  <ng-container *ngFor="let dataRow of tableData; trackBy: trackByFnBody">
    <tr class="h-12 text-sm border-b-btw text-btw">
      <ng-container *ngFor="let config of tableColumnConfig; trackBy: trackByFnHeader">
        <ng-container [ngSwitch]="config.column_pipe">
          <ng-container *ngSwitchCase="'normal'">
            <td class="max-w-96 text-ellipsis text-xs border-r-btw" *ngIf="configColumn(config)">
              <p class="w-full px-3 text-ellipsis overflow-hidden max-h-24">
                {{ getDataRow(dataRow, config) }}
              </p>
            </td>
          </ng-container>
          <ng-container *ngSwitchCase="'cash'">
            <td class="max-w-96 text-ellipsis text-xs border-r-btw" *ngIf="configColumn(config)">
              <p class="w-full px-3 text-ellipsis overflow-hidden">
                {{ getDataRow(dataRow, config) | currency }}
              </p>
            </td>
          </ng-container>
          <ng-container *ngSwitchCase="'badge'">
            <td *ngIf="configColumn(config)" class="max-w-96 border-r-btw">
              <ng-container *ngFor="let optionBadge of config.column_config || []">
                <div class="flex h-8 w-8 mx-auto rounded-md justify-center items-center text-white"
                     [title]="optionBadge.custom_label"
                     *ngIf="optionBadge.custom_key == getDataRow(dataRow, config)"
                     [ngStyle]="{background: optionBadge.custom_color || 'var(--color-primary)'}">
                  <span>
                    <i class="fa fa-solid" [ngClass]="optionBadge.custom_icon"></i>
                  </span>
                </div>
              </ng-container>
            </td>
          </ng-container>
          <ng-container *ngSwitchCase="'custom'">
            <td class="max-w-96 text-ellipsis text-xs border-r-btw"
                *ngIf="configColumn(config)&&config.column_fn">
              <p class="w-full px-3 text-ellipsis overflow-hidden max-h-24">
                {{ config.column_fn(getDataRow(dataRow, config)) }}
              </p>
            </td>
          </ng-container>
        </ng-container>
      </ng-container>
      <ng-container *ngIf="quicklyActions">
        <td class="border-r-btw">
          <div class="flex gap-2 overflow-x-auto justify-center items-center my-auto h-12">
            <ng-container *ngFor="let action of tableQuicklyActionsConfig">
              <ng-container *ngIf="!action.condition && action.active">
                <button [title]="action.label"
                        class="h-8 w-8 flex justify-center items-center p-3 rounded-md bg-btw-primary border border-btw"
                        (click)="eventRow(dataRow, action.nameEvent)" [ngStyle]="{
              backgroundColor: action.background || 'var(--color-bg)',
              color: action.color || 'var(--color-text-btw)'
              }"><span><i
                  [class]="'fa fa-solid fa-'+action.icon"></i></span></button>
              </ng-container>
              <ng-container *ngIf="action.condition && action.condition(dataRow) && action.active">
                <button [title]="action.label"
                        class="h-8 w-8 flex justify-center items-center p-3 rounded-md bg-btw-primary border border-btw"
                        (click)="eventRow(dataRow, action.nameEvent)" [ngStyle]="{
              backgroundColor: action.background || 'var(--color-bg)',
              color: action.color || 'var(--color-text-btw)'
              }"><span><i
                  [class]="'fa fa-solid fa-'+action.icon"></i></span></button>
              </ng-container>
            </ng-container>
          </div>
        </td>
      </ng-container>
      <ng-container *ngIf="multipleActions">
        <td>
          <div class="flex gap-2 justify-center items-center my-auto h-12">
            <app-button-dropdown [actions]="tableFieldActionsConfig" [data]="dataRow"
                                 (eventClick)="eventRow($event.data, $event.event)"></app-button-dropdown>
          </div>
        </td>
      </ng-container>
    </tr>
  </ng-container>
  </tbody>
</ng-template>
